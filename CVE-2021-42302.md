# Summary

The Azure RTOS USBX _ux_host_class_audio_read function prepares read of wMaxPacketSize bytes of data from a usb device without assuring that a buffer overflow won't take place.

# Description

The Azure RTOS USBX function includes code as below:
```
    audio_transfer_request -> ux_host_class_audio_transfer_request_requested_length =
                            audio -> ux_host_class_audio_isochronous_endpoint -> ux_endpoint_descriptor.wMaxPacketSize;

    /* Ask the stack to hook this transfer request to the iso ED.  */
    status =  _ux_host_class_audio_transfer_request(audio, audio_transfer_request);
```

As one may observe the requested transfer length is set to the endpoint's wMaxPacketSize descriptor entry. This value is read from an actual usb device so in case of malicious device it may be manipulated to have an unexpected two byte value like 0xffff. Since the original requested length, along with the allocated buffer, provided by the application layer may be smaller than wMaxPacketSize (i.e. 4096 bytes) this will allow a buffer overflow. An attacker will be able to write arbitrary data past the buffer boundary. This in turn, depending on actual end application, may lead to modification of important data structures, bypass of security functionality or in the worst case execution of arbitrary code.

# Reproduction steps

- prepare an audio application
- allocate a fixed size buffer for data, i.e. 4096 bytes
- prepare a audio_transfer_request with requested length to 1024
- call _ux_host_class_audio_read
- prepare a malicious usb audio device with isochronous descriptor wMaxPacketSize set to a value larger than the allocated buffer, for example 0xffff
- check for buffer overflow

# References

https://github.com/azure-rtos/usbx/blob/master/common/usbx_host_classes/src/ux_host_class_audio_read.c

# Affected versions

<= 6.1.8