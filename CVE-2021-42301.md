# Summary

The USB device stack implementation of Azure RTOS (UsbX) includes a buffer overflow vulnerability allowing one to read memory past buffer boundary.

# Description

The issue is located in _ux_device_stack_control_request_process function (as defined in usbx/common/core/src/ux_device_stack_control_request_process.c). Successful processing of received control transfer request by a registered application handler (ux_system_slave_device_vendor_request_function) will be followed by transfer of request_length bytes to the host, where request_length is a user controlled value specified in the received usb message. The request_length value is not limited to buffer size thus allowing buffer overflow, possibly up to 0xffff (request_length is a uint16 per standard).

Execution flow steps:
- control request transfer message received, properties set as following
    - request_type = UX_REQUEST_TYPE_VENDOR
    - request = _ux_system_slave -> ux_system_slave_device_vendor_request)
- ux_system_slave_device_vendor_request_function is executed, returns UX_SUCCESS, sets application_data_length
- _ux_device_stack_transfer_request(transfer_request, request_length, application_data_length) call results in transfer of request_length bytes of data (0xffff) to the host, buffer overflow occurs

The call of _ux_device_stack_transfer_request has reordered parameters, application_data_length should be passed as second parameter and request_length third to transfer only the amount of data provided by application layer.
The described buffer overflow results in microcontroller memory readout possibly leaking sensitive information like credentials or encryption keys.

# Reproduction steps

- prepare a test application with a registered vendor request handler
- issue a usb control transfer in request of type vendor and wLength 0xffff
- observe a read buffer overflow exposing contents of MCU's memory

# References

https://github.com/azure-rtos/usbx/blob/master/common/core/src/ux_device_stack_control_request_process.c

# Affected versions

<= 6.1.8
