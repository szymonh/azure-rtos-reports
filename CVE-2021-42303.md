# Summary

The Azure RTOS USBX _ux_host_class_video_read, _ux_host_class_video_transfer_buffer_add and _ux_host_class_video_transfer_buffers_add functions prepare read transfers of based on wMaxPacketSize without assuring that a buffer overflow will not take place.

# Description

The USBX function _ux_host_class_video_read includes code like below:
```
    packet_size = video -> ux_host_class_video_isochronous_endpoint -> ux_endpoint_descriptor.wMaxPacketSize;
    if (packet_size &amp; UX_MAX_NUMBER_OF_TRANSACTIONS_MASK)
        packet_size = (packet_size &amp; UX_MAX_PACKET_SIZE_MASK) * (((packet_size &amp; UX_MAX_NUMBER_OF_TRANSACTIONS_MASK) >> UX_MAX_NUMBER_OF_TRANSACTIONS_SHIFT) + 1);

    /* Fill the transfer request with all the required fields.  */
    transfer_request -> ux_transfer_request_endpoint =             video -> ux_host_class_video_isochronous_endpoint;
    transfer_request -> ux_transfer_request_data_pointer =         buffer;
    transfer_request -> ux_transfer_request_requested_length =     packet_size;
    transfer_request -> ux_transfer_request_completion_function =  _ux_host_class_video_transfer_request_callback;
    transfer_request -> ux_transfer_request_class_instance =       video;

    /* Add single transfer.  */
    transfer_request -> ux_transfer_request_next_transfer_request = UX_NULL;

    /* Transfer the transfer request.  */
    status =  _ux_host_stack_transfer_request(transfer_request)
```

As one may observe the requested transfer length (transfer_request -> ux_transfer_request_requested_length) is set to packet_size, which in turn is based on wMaxPacketSize which originates from the usb device's endpoint descriptor. A malicious device may include the endpoint descriptor wMaxPacketSize crafted to an unexpected value potentially allowing buffer overflow, where attacker provided data will be written past buffer boundary.
If wMaxPacketSize read from the usb device endpoint descriptor has the value of 0xe7ff (two bytes) than the if condition won't be true (0xe7ff & 0x1800 = 0) the packet_size and ux_transfer_request_requested_length will be set to 0xe7ff potentially allowing write of 59391 bytes which may result in a buffer overflow. Depending on the actual application this may result in modification of important data structures, bypass of security features or in the worst case execution of arbitrary code.
Similar situation as described above affects also functions:
_ux_host_class_video_transfer_buffer_add
_ux_host_class_video_transfer_buffers_add

# Reproduction steps

- prepare a video application
- allocate a fixed size buffer for data, i.e. 4096 bytes
- prepare a audio_transfer_request with requested length to 1024
- call _ux_host_class_video_read
- prepare a malicious usb video device with endpoint descriptor wMaxPacketSize set to a unexpected value like 0xe7ff.
- check for buffer overflow.

# References

https://github.com/azure-rtos/usbx/blob/master/common/usbx_host_classes/src/ux_host_class_video_read.c

# Affected versions

<= 6.1.8